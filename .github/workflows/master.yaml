name: Run on Change
on:
  push:
    branches:
      - 'feat-*'

jobs:
  # JOB to run change detection
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      middleware: ${{ steps.filter.outputs.middleware }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            middleware:
              - 'middleware/**'

  # JOB to test and create PR for backend changes
  backend:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout backend code
        uses: actions/checkout@v2
      - name: Debug GitHub Context
        run: |
           echo "Branch name: ${{ github.head_ref }}"
            echo  "Branch name2: ${{ github.head_ref || github.ref_name }}"
      - name: Create Pull Request for Backend
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: ${{ github.head_ref || github.ref_name }} 
          title: 'Auto-generated PR for Backend changes'
          body: 'This PR was created automatically due to changes in the backend directory.'
          base: stagging

  # JOB to test and create PR for frontend changes
  frontend:
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout frontend code
        uses: actions/checkout@v2

      - name: Dummy Step for Frontend
        run: echo "Hello...I am a frontend step!"

      - name: Create Pull Request for Frontend
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: ${{ github.head_ref || github.ref_name }} 
          title: 'Auto-generated PR for Frontend changes'
          body: 'This PR was created automatically due to changes in the frontend directory.'
          base: stagging

  # JOB to test and create PR for middleware changes
  middleware:
    needs: changes
    if: ${{ needs.changes.outputs.middleware == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout middleware code
        uses: actions/checkout@v2

      - name: Dummy Step for Middleware
        run: echo "Hello...I am a middleware step!"

      - name: Create Pull Request for Middleware
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: ${{ github.head_ref || github.ref_name }} 
          title: 'Auto-generated PR for Middleware changes'
          body: 'This PR was created automatically due to changes in the middleware directory.'
          base: stagging
